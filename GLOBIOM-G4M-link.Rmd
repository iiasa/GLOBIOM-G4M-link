---
title: "GLOBIOM-G4M-link"
subtitle: R notebook for automatizing the link between GLOBIOM and G4M.
author:
- Andrey L. D. Augustynczik
- Albert Brouwer 
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_notebook
---

Before using this notebook, please first read the [introductory documentation](https://iiasa.github.io/GLOBIOM-G4M-link). Run the code chunks in first-to-last order. You can have RStudio run all chunks in one go, but to configure and test your setup---and because some chunks take a long time to run---it is advisable to start out by running chunks one-by-one at least until you have verified that everything is working smoothly.

Carefully check the output of each chunk for errors, and if present make adjustments and re-run the chunk that failed.

## Read the default configuration and list of optional configuration settings

```{r}
# Remove any objects from environment and read the default configuration
rm(list=ls())
source("R/configuration/default.R")

# Collect the names and types of the default config parameters
config_names <- ls()
config_types <- lapply(lapply(config_names, get), typeof)

# Read list of optional config settings and remove mandatory settings form the environment
source("R/configuration/optional.R")
rm(list=config_names[!(config_names %in% OPTIONAL_CONFIG_SETTINGS)])
```

## Load required packages

```{r}
library(gdxrrw)
library(gdxtools)
suppressWarnings(library(tidyverse))
library(stringr) # part of the tidyverse, but not attached by default
library(fs)
```

## Customize configuration

```{r}
custom_configuration_file <- "R/configuration/custom.R"

# Check that custom configuration exists, edit a new one otherwise.
if (!file_exists(custom_configuration_file)) {
  warning("Custom configuration file missing, please customize.")
  file_copy("R/configuration/default.R", custom_configuration_file)
  rstudioapi::navigateToFile(custom_configuration_file)
}
```

## Load and check custom configuration

When all if fine, the configuration is echoed.

```{r}
source(custom_configuration_file, local=TRUE, echo=FALSE)
source("R/configuration/check_and_echo.R")
```

## Check that submodules and a GLOBIOM branch are available

When executing this chunk fails, [read this](https://iiasa.github.io/GLOBIOM-G4M-link/#getting-set).

```{r}
if (!file_exists(path("Condor_run_R", "Condor_run.R"))) stop ("Condor_run_R submodule content is missing!")
if (!file_exists(path(WD_DOWNSCALING, "README.md"))) stop ("DownScaling submodule content is missing!")
if (!dir_exists(path(WD_GLOBIOM, "Model"))) stop ("No GLOBIOM branch has been checked out!")
```

## Set up directories and functions

```{r}
# Cache working directory
CD <- getwd()

# Canonicalize path to temporary directory for this R session
TEMP_DIR <- path(tempdir())

# Source support functions
source("R/globiom_g4m_functions.R")
source("R/helper_functions.R")
```

## Perform the initial GLOBIOM run

```{r}
# Set wd 
wd <- path_wd(WD_GLOBIOM)

# Run GLOBIOM scenarios
cluster_nr <- call_condor_run(wd)

print("Initial GLOBIOM run complete.")
```

## Edit and run post-processing script

```{r}

run_postproc_initial(wd, cluster_nr)

```

## Perform the initial downscaling - needs data from the initial GLOBIOM run

```{r}
if (!file_exists(path(WD_DOWNSCALING,"input",str_glue("output_landcover_{PROJECT}_{DATE_LABEL}.gdx"))))
  stop("File for downscaling not found! Please call the intial GLOBIOM run before downscaling")

# Set wd 
wd <- path_wd(WD_DOWNSCALING)

# Edit Downscaling script
edit_downscaling(wd)

# Run Downscaling scenarios
cluster_nr <- call_condor_run(wd)

print("Initial downscaling complete")
```

## Merge downscaling outputs and transfer them to G4M

```{r}
merge_and_transfer(wd,cluster_nr)
```

## TODO: Run G4M - needs data from the intial downscaling

```{r}
if (!file_exists(path(PATH_FOR_G4M,str_glue("{GDX_OUTPUT_NAME}_output_{PROJECT}_{DATE_LABEL}"))))
  stop("File for G4M run not found! Please call the intial downscaling before the G4M run")
    
# Run G4M
```

## TODO: Perform the final GLOBIOM run - needs data from the G4M run

```{r}
# Edit and run post-processing script
# Set wd 
wd <- path_wd(WD_GLOBIOM)
run_postproc_final(wd)
```

## TODO: Perform the final downscaling - needs data from the final GLOBIOM run


```{r}
# Run final downscaling
```
